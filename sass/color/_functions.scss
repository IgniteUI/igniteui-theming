@use 'sass:map';
@use 'sass:meta';
@use 'sass:math';
@use 'sass:list';
@use 'sass:color';
@use 'sass:string';
@use 'types';
@use 'multipliers';
@use '../utils' as *;

/// Generates a color palette.
/// @access public
/// @group Palettes
/// @requires {function} _color-palette
/// @param {Color} $primary - The primary color used to generate the primary color palette.
/// @param {Color} $secondary - The secondary color used to generate the secondary color palette.
/// @param {Color} $surface - The color used as a background in components, such as cards, sheets, and menus
/// @param {Color} $gray [null] - The color used for generating the grays palette.
/// @param {Color} $info [null] - The information color used throughout the application.
/// @param {Color} $success [null] - The success color used throughout the application.
/// @param {Color} $warn [null] - The warning color used throughout the application.
/// @param {Color} $error [null] - The error color used throughout the application.
/// @param {String} $variant [null] - The palette variant that gets generated.
/// @returns {Map} - A map consisting of color shades for the passed base colors(primary, secondary, gray, etc).
@function palette(
    $primary,
    $secondary,
    $surface,
    $gray,
    $info: null,
    $success: null,
    $warn: null,
    $error: null,
    $variant: null,
) {
    $color-shades: map.keys(types.$IColorShades);
    $gray-shades: map.keys(types.$IGrayShades);
    $primary-palette: shades(primary, $primary, $color-shades);
    $secondary-palette: shades(secondary, $secondary, $color-shades);
    $surface-palette: shades(surface, $surface, $color-shades);
    $grayscale-palette: shades(gray, $gray, $gray-shades, $surface);
    $info-palette: if($info, shades(info, $info, $color-shades), ());
    $success-palette: if($success, shades(success, $success, $color-shades), ());
    $warn-palette: if($warn, shades(warn, $warn, $color-shades), ());
    $error-palette: if($success, shades(error, $error, $color-shades), ());

    @return (
        primary: $primary-palette,
        secondary: $secondary-palette,
        gray: $grayscale-palette,
        surface: $surface-palette,
        info: $info-palette,
        success: $success-palette,
        warn: $warn-palette,
        error: $error-palette,
        _meta: (
            variant: $variant,
        )
    );
}

/// Generates a Material-like color palette from a base color.
/// @access public
/// @group Palettes
/// @param {String} $name - The name of the color.
/// @param {Color} $color - The base color used to generate the palette.
/// @param {List} $shades - The list of shades.
/// @param {Color} $surface [null] - The surface color. Usefull when generating shades of gray (optional).
/// @requires {function} _color-shade
/// @requires {function} _hsla-shade
/// @requires {function} contrast
/// @requires {function} to-opaque
/// @returns {Map} - A map consisting of hsla color shades and thier respective contrast colors.
@function shades(
    $name,
    $color,
    $shades,
    $surface: null
) {
    $result: ();

    @each $variant in $shades {
        $shade: shade($name, $color, $variant, $surface);
        $result: map.merge(
            $result,
            (
                $variant: map.get($shade, 'raw'),
                #{$variant}-contrast: text-contrast(map.get($shade, 'raw')),
                #{$variant}-hsl: map.get($shade, 'hsl'),
            )
        );
    }

    @return $result;
}

/// Generates a color shade for a given base colors.
/// @access private
/// @group Palettes
/// @param {String} $name - The base color name (primary, secondary, etc.) to be used to generate a color variant.
/// @param {Color} $color - The color value to be used to generate a color shade.
/// @param {String | Number} $shade - The color shade variant.
/// @param {Color} $surface [null] - The surface color. Usefull when generating a shade of gray (optional).
/// @returns {Map} - A map containing a list of HSL values and a raw color value.
@function shade(
    $name,
    $color,
    $shade,
    $surface: null,
) {
    $h: var(--ig-#{$name}-h);
    $s: var(--ig-#{$name}-s);
    $l: var(--ig-#{$name}-l);

    @if $name == gray {
        $lum: luminance($surface);
        $lmap: map.get(multipliers.$grayscale, 'l');
        $len: list.length($lmap);
        $i: list.index(map.keys($lmap), $shade);
        $l: list.nth(map.values($lmap), if($lum > .5, $len - $i + 1, $i));

        @return (
            raw: hsl(
                to-fixed(color.hue($color)),
                to-fixed(color.saturation($color)),
                $l
            ),
            hsl: #{$h, $s, $l}
        );
    } @else {
        $sx: map.get(multipliers.$color, 's', $shade);
        $lx: map.get(multipliers.$color, 'l', $shade);

        @return (
            raw: hsl(
                to-fixed(color.hue($color)),
                to-fixed(color.saturation($color) * $sx),
                to-fixed(color.lightness($color) * $lx)
            ),
            hsl: #{$h, calc(#{$s} * #{$sx}), calc(#{$l} * #{$lx})}
        );
    }
}

/// Retrieves a color from a color palette.
/// @access public
/// @group Palettes
/// @param {Map} $palette [null]- The source palette map (optional).
/// @param {String} $color [primary]- The target color from the color palette.
/// @param {Number | String} $variant [500] - The target color shade from the color palette.
/// @param {Number} $opacity [null] - Optional opacity to apply to the color shade.
/// @returns {Color | String} - The raw color shade or CSS variable reference from the palette.
@function color($palette: null, $color: primary, $variant: 500, $opacity: null) {
    $c: map.get($palette or types.$IPalette, $color);
    $a: var(--ig-#{$color}-a);
    $s: #{var(--ig-#{$color}-#{$variant})};
    $contrast: if(
        meta.type-of($variant) == string,
        string.index($variant, 'contrast'),
        false
    );
    $meta: if($palette, map.get($palette, '_meta'), null);

    @if not($c) {
        @error 'The passed color #{$color} is not valid.';
    }

    @if not($palette) or not($meta) {
        @return if(
            $contrast,
            $s,
            hsla($s, if($opacity, $opacity, $a)),
        );
    }

    @return rgba(map.get($c, $variant), $alpha: if($opacity, $opacity, 1));
}

/// Retrieves a contrast text color for a given color from a color palette.
/// @access public
/// @group Palettesreference
/// @param {Map} $palette [null]- The source palette map (optional).
/// @param {String} $color [primary]- The target color from the color palette.
/// @param {Number | String} $variant [500] - The target color shade from the color palette.
/// @requires color
/// @returns {Color | String} - The raw contrast color shade or CSS variable from the palette.
@function contrast-color($palette: null, $color: primary, $variant: 500) {
    @return color($palette, $color, #{$variant}-contrast);
}

/// Returns a contrast color for a passed color.
/// @access public
/// @group Color
/// @param {Color} $background - The background color used to return a contrast/forground color for.
/// @param {Color | List<Color>} $foreground [#fff] - A list of foreground colors
/// that can be used with the provided background.
/// @param {AAA | AA | A} $contrast [AAA] - The contrast level according to WCAG 2.0 standards.
/// @returns {Color} - Returns either white, black, or the provided foreground
/// color if it meets the required contrast level.
/// @link https://www.w3.org/TR/UNDERSTANDING-WCAG20/visual-audio-contrast-contrast.html
@function text-contrast(
    $background,
    $foreground: white,
    $contrast: 'AAA'
) {
    @if meta.type-of($foreground) != 'list' and meta.type-of($background) != 'color' {
        @return $background;
    }

    $level: map.get(
        (
            'a': 3,
            'aa': 4.5,
            'aaa': 7
        ),
        string.to-lower-case($contrast)
    );

    @if not($level) {
        @error "$contrast must be 'A', 'AA', or 'AAA'";
    }

    $candidates: ();

    @each $color in $foreground {
        @if meta.type-of($color) != 'color' {
            @return $background;
        }

        $candidates: list.append($candidates, contrast($background, $color));
    }

    $foreground: list.nth($foreground, list.index($candidates, math.max($candidates...)));

    @if contrast($background, $foreground) >= $level {
        @return $foreground;
    } @else {
        $lightContrast: contrast($background, white);
        $darkContrast: contrast($background, black);

        @if $lightContrast > $darkContrast {
            @return white;
        } @else {
            @return black;
        }
    }
}

/// Mixes two colors to produce an opaque color.
/// @access public
/// @param {Color} $color-1 - The first color, usually transparent.
/// @param {Color} $color-2 [#fff] - The second color, usually opaque.
/// @return {Color} - The color representation of the rgba value.
@function to-opaque($color-1, $color-2: #fff) {
    @if meta.type-of($color-1) == color and meta.type-of($color-2) == color {
        $red: color.red($color-1);
        $green: color.green($color-1);
        $blue: color.blue($color-1);
        $a: color.alpha($color-1);
        $r: math.floor($a * $red + (1 - $a) * color.red($color-2));
        $g: math.floor($a * $green + (1 - $a) * color.green($color-2));
        $b: math.floor($a * $blue + (1 - $a) * color.blue($color-2));

        @return rgb($r, $g, $b);
    }

    @return $color-1;
}

/// Retruns a comma separated list of hue, saturation, and lightness values for a given color.
/// @access public
/// @param {Color} $color - The color to be converted to an HSL list of values.
/// @example scss Turn #000 into an HSL list of values
///   $hsl-list: to-hsl(#000); // (0deg, 0%, 0%);
/// @return {List} - This list of HSL values.
@function to-hsl($color) {
    @return (color.hue($color), color.saturation($color), color.lightness($color));
}

/// Calculates the contrast ratio between two colors.
/// See https://www.w3.org/TR/WCAG20-TECHS/G17.html#G17-tests
///
/// @param {Color} $background - The background color.
/// @param {Color} $foreground - The foreground color.
/// @returns {Number} - The contrast ratio between the background and foreground colors.
@function contrast($background, $foreground) {
    $backLum: luminance($background) + .05;
    $foreLum: luminance($foreground) + .05;

    @return to-fixed(math.div(math.max($backLum, $foreLum), math.min($backLum, $foreLum)));
}

/// Calculates the luminance for a given color.
/// See https://www.w3.org/TR/WCAG20-TECHS/G17.html#G17-tests.
///
/// @param {Color} $color - The color to calculate luminance for.
@function luminance($color) {
    @if meta.type-of($color) == 'color' {
        $r: math.div(color.red($color), 255);
        $g: math.div(color.green($color), 255);
        $b: math.div(color.blue($color), 255);

        @return .2126 * _lcv($r) + .7152 * _lcv($g) + .0722 * _lcv($b);
    }

    @return $color;
}

/// Calculates the linear channel value for a given sRGB color.
/// @access private
@function _lcv($value) {
    /* stylelint-disable number-max-precision */
    @return if(
        $value < .03928,
        math.div($value, 12.92),
        math.pow(math.div($value + .055, 1.055), 2.4)
    );
}
