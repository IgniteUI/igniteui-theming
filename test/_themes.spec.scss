/* stylelint-disable value-no-vendor-prefix */
/* stylelint-disable color-function-notation */
/* stylelint-disable max-nesting-depth */
@use 'sass:list';
@use 'sass:map';
@use 'sass:meta';
@use '../node_modules/sass-true/' as *;
@use '../index' as *;

$schema: (
    background: (
        color: (primary, 400)
    ),
    hover-background: (
        color: (secondary, 700, .26)
    ),
    foreground: (
        contrast-color: (primary, 400)
    ),
    hover-foreground: contrast-color($color: secondary, $variant: 700),
    border-style: solid,
    border-radius: rem(2px),
    brushes: series,
    resting-elevation: 2,
);

@include describe('Themes') {
    @include describe('schemas') {
        @include it('should resolve values from function instructions') {
            $instructions: (
                (color: primary),
                (contrast-color: (primary, '400')),
            );
            $results: (
                color($color: primary),
                contrast-color($color: primary, $variant: '400'),
            );

            @for $i from 1 through list.length($instructions) {
                $instruction: list.nth($instructions, $i);
                $result: list.nth($results, $i);

                @include assert-equal(resolve-value($instruction), $result);
            }
        }

        @include it('should output theme maps from schema definitions') {
            $theme: (
                background: hsla(var(--ig-primary-400), var(--ig-primary-a)),
                hover-background: hsla(var(--ig-secondary-700), .26),
                foreground: var(--ig-primary-400-contrast),
                hover-foreground: var(--ig-secondary-700-contrast),
                border-style: solid,
                border-radius: .125rem,
                brushes: #{chart-brushes()},
                resting-elevation: var(--ig-elevation-2),
            );

            @include assert-equal(digest-schema($schema), $theme);
        }

        @include it('should retrieve a reference to the CSS variable for a given theme') {
            $theme: map.merge(digest-schema($schema), (name: 'igc-avatar'));

            @include assert-equal(var-get($theme, 'background', inherit), var(--background, inherit));
        }

        @include it('should convert component theme props into CSS variables') {
            $name: 'igc-avatar';
            $theme: digest-schema($schema);

            @include assert() {
                @include output() {
                    @include css-vars-from-theme($theme, $name);
                }

                @include expect() {
                    @each $key, $value in $theme {
                        --#{$key}: var(--#{$name}-#{$key}, #{$value});
                    }
                }
            }
        }

        @include it('should ignore all keys in the ignore list') {
            $name: 'igc-avatar';
            $theme: digest-schema($schema);

            @each $key in $ignored-keys {
                $theme: map.merge($theme, (#{$key}: 'test'));
            }

            @include assert() {
                @include output() {
                    @include css-vars-from-theme($theme, $name);
                }

                @include expect() {
                    @each $key, $value in map.remove($theme, $ignored-keys...) {
                        --#{$key}: var(--#{$name}-#{$key}, #{$value});
                    }
                }
            }
        }

        @include it('should scope theme CSS variables to correctly') {
            $name: 'igc-avatar';
            $theme: map.merge(digest-schema($schema), (name: $name));

            // Calling from the root of the stylesheet
            @include assert() {
                @include output($selector: false) {
                    @include css-vars($theme);
                }

                @include expect($selector: false) {
                    #{$name} {
                        @each $key, $value in map.remove($theme, $ignored-keys...) {
                            --#{$key}: var(--#{$name}-#{$key}, #{$value});
                        }
                    }
                }
            }

            // Calling from within another selector
            @include assert() {
                @include output($selector: false) {
                    .my-theme {
                        @include css-vars($theme);
                    }
                }

                @include expect($selector: false) {
                    .my-theme,
                    .my-theme #{$name} {
                        @each $key, $value in map.remove($theme, $ignored-keys...) {
                            --#{$key}: var(--#{$name}-#{$key}, #{$value});
                        }
                    }
                }
            }
        }

        @include it('should scope theme CSS variables to a specified scope') {
            $name: 'igc-avatar';
            $theme: map.merge(digest-schema($schema), (name: $name));

            // Calling from the root of the stylesheet w/ custom selector provided
            @include assert() {
                @include output($selector: false) {
                    @include css-vars($theme, '.custom-selector');
                }

                @include expect($selector: false) {
                    .custom-selector {
                        @each $key, $value in map.remove($theme, $ignored-keys...) {
                            --#{$key}: var(--#{$name}-#{$key}, #{$value});
                        }
                    }
                }
            }

            // Calling from within another selector w/ custom selector provided
            @include assert() {
                @include output($selector: false) {
                    .my-theme {
                        @include css-vars($theme, '.custom-selector');
                    }
                }

                @include expect($selector: false) {
                    .my-theme,
                    .my-theme .custom-selector {
                        @each $key, $value in map.remove($theme, $ignored-keys...) {
                            --#{$key}: var(--#{$name}-#{$key}, #{$value});
                        }
                    }
                }
            }
        }

        @include it('should set the border-radius to a value between min and max') {
            $border-radius: border-radius(4px, 2px, 3px);
            $expected: meta.inspect(clamp(2px, var(--ig-radius-factor) * 4px, 3px));

            @include assert-equal($assert: $border-radius, $expected: $expected, $inspect: true);
        }

        @include it('should include border-radius styles to a given scope with a value between min and max') {
            $expected: meta.inspect(clamp(2px, var(--ig-radius-factor) * 4px, 3px));

            @include assert() {
                @include output() {
                    @include border-radius(4px, 2px, 3px);
                }

                @include expect() {
                    border-radius: $expected;
                }
            }
        }

        @include it('include single-line truncate styles when the ellipsis mixin is included') {
            @include assert() {
                @include output() {
                    @include ellipsis();
                }

                @include expect() {
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    overflow: hidden;
                }
            }
        }

        @include it('includes multi-line truncate styles when the line-clamp mixin is included') {
            @include assert() {
                @include output() {
                    @include line-clamp(3, true, true);
                }

                @include expect() {
                    display: -webkit-inline-box;
                    -webkit-line-clamp: 3;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                }
            }
        }

        @include it('includes styles that hide the default element when the hide-default mixin is included') {
            @include assert() {
                @include output() {
                    @include hide-default();
                }

                @include expect() {
                    position: absolute;
                    width: 1px;
                    height: 1px;
                    margin: -1px;
                    border: none;
                    clip: rect(0, 0, 0, 0);
                    outline: 0;
                    pointer-events: none;
                    overflow: hidden;
                    appearance: none;
                }
            }
        }
    }
}
